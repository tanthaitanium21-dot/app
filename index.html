<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>กรุณาเข้าสู่ระบบ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f4f7f9; }
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(24, 49, 79, 0.8); display: flex; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(5px); }
        #main-content { display: none; }
        .form-input { border-radius: 0.5rem; border-color: #cbd5e1; }
        .btn { border-radius: 0.5rem; font-weight: 700; padding-top: 0.75rem; padding-bottom: 0.75rem; transition: all 0.3s ease; }
        .btn-primary { background-image: linear-gradient(to right, #3b82f6, #2563eb); color: white; }
    </style>
</head>
<body class="antialiased">

    <!-- 1. หน้าสำหรับล็อกอิน -->
    <div id="login-overlay">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-sm m-4">
            <h2 class="text-2xl font-bold text-center text-slate-800 mb-4">กรุณาใส่รหัสเพื่อใช้งาน</h2>
            <form id="login-form">
                <input type="text" id="access-code" class="form-input w-full p-3 text-center text-lg tracking-widest" placeholder="ACCESS-CODE" required>
                <button id="login-button" type="submit" class="btn btn-primary w-full mt-4 text-lg">เข้าสู่ระบบ</button>
            </form>
            <p id="login-status" class="text-center text-red-500 mt-4 h-5"></p>
        </div>
    </div>

    <!-- 2. พื้นที่สำหรับแสดงแอป (หลังจากล็อกอิน) -->
    <div id="main-content">
         <!-- เนื้อหาแอปจะถูกโหลดมาใส่ตรงนี้ -->
    </div>
    
    <script>
        // นี่คือจุดที่ API ของเราอยู่ (ตามที่ตั้งค่าใน netlify.toml)
        const API_ENDPOINT = '/api/validate';
        let appData = {}; // ตัวแปรสำหรับเก็บข้อมูลจากหลังบ้าน

        document.addEventListener('DOMContentLoaded', () => {
            const loginForm = document.getElementById('login-form');
            const accessCodeInput = document.getElementById('access-code');
            const loginStatus = document.getElementById('login-status');
            const loginButton = document.getElementById('login-button');
            const loginOverlay = document.getElementById('login-overlay');
            const mainContent = document.getElementById('main-content');
            
            // --- ส่วนที่ 1: ตรวจสอบว่าเคยล็อกอินไว้ใน Session นี้หรือยัง ---
            const sessionToken = sessionStorage.getItem('sessionToken');
            if (sessionToken) {
                 unlockApp(sessionToken);
            }

            // --- ส่วนที่ 2: จัดการการล็อกอิน ---
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const code = accessCodeInput.value.trim();
                if (!code) return;

                loginButton.disabled = true;
                loginButton.textContent = 'กำลังตรวจสอบ...';
                loginStatus.textContent = '';

                try {
                    // ยิงไปที่ Serverless Function (action: validateCode)
                    const response = await fetch(API_ENDPOINT, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'validateCode', code: code }),
                    });

                    const result = await response.json();
                    if (!response.ok) throw new Error(result.message || 'เกิดข้อผิดพลาด');

                    if (result.success && result.token) {
                        // ถ้าสำเร็จ ให้เก็บ Token ไว้ใน sessionStorage
                        sessionStorage.setItem('sessionToken', result.token); 
                        // ปลดล็อกแอป
                        unlockApp(result.token);
                    } else {
                        throw new Error(result.message || 'รหัสไม่ถูกต้อง');
                    }
                } catch (error) {
                    console.error('Login Error:', error);
                    loginStatus.textContent = error.message;
                    loginButton.disabled = false;
                    loginButton.textContent = 'เข้าสู่ระบบ';
                }
            });
            
            // --- ส่วนที่ 3: ฟังก์ชันปลดล็อกแอป ---
            async function unlockApp(token) {
                 try {
                    // ยิงไปที่ Serverless Function (action: getAppData)
                    // **สำคัญ:** เราต้องส่ง Token ที่ได้มา ไปใน Header 'Authorization' ด้วย
                    const response = await fetch(API_ENDPOINT, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}` // ส่ง Token เพื่อยืนยันตัวตน
                        },
                        body: JSON.stringify({ action: 'getAppData' })
                    });
                    
                    if (!response.ok) {
                        const errorResult = await response.json();
                        // ถ้า Token ผิด (เช่น โดนรีเฟรช) ให้ลบ Token ทิ้ง
                        if (response.status === 401) {
                            sessionStorage.removeItem('sessionToken');
                        }
                        throw new Error(errorResult.message || 'ไม่สามารถโหลดข้อมูลแอปได้');
                    }
                    
                    const data = await response.json();
                    
                    if (!data.success || !data.appHTML || !data.appData) {
                         throw new Error('ข้อมูลแอปที่ได้รับไม่สมบูรณ์');
                    }
                    
                    appData = data.appData; // เก็บข้อมูล data ไว้ในตัวแปร global

                    // ซ่อนหน้าล็อกอิน
                    loginOverlay.style.display = 'none';
                    // แสดงเนื้อหาแอป
                    mainContent.innerHTML = data.appHTML;
                    mainContent.style.display = 'block';
                    
                    // (สำคัญ) รันสคริปต์ที่อยู่ใน HTML ที่เพิ่งโหลดมา
                    const scriptTag = mainContent.querySelector('script#main-calculator-script');
                    if(scriptTag) {
                        const newScript = document.createElement('script');
                        newScript.innerHTML = scriptTag.innerHTML;
                        document.body.appendChild(newScript);
                    }

                } catch (error) {
                    console.error('Unlock App Error:', error);
                    loginOverlay.style.display = 'flex'; // ถ้าเฟล ให้กลับไปหน้าล็อกอิน
                    loginStatus.textContent = `เกิดข้อผิดพลาด: ${error.message}`;
                    // เคลียร์ Token ที่อาจใช้ไม่ได้แล้ว
                    sessionStorage.removeItem('sessionToken');
                }
            }
        });
    </script>
</body>
</html>

